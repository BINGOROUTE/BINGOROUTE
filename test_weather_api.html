<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚ ì”¨ API í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .weather-card { background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .score-circle { display: inline-block; width: 60px; height: 60px; border-radius: 50%; 
                       background: #667eea; color: white; text-align: center; line-height: 60px; 
                       font-weight: bold; margin-right: 10px; }
        .best-day { background: #e8f5e8; border-left: 4px solid #4caf50; }
        button { padding: 10px 20px; margin: 5px; background: #2563eb; color: white; 
                border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1d4ed8; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸŒ¤ï¸ ë‚ ì”¨ API í…ŒìŠ¤íŠ¸</h1>
    
    <div class="section">
        <h2>API í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testCurrentWeather()">í˜„ì¬ ë‚ ì”¨ ì¡°íšŒ</button>
        <button onclick="testMidForecast()">ì¤‘ê¸° ì˜ˆë³´ ì¡°íšŒ</button>
        <button onclick="testWeatherStats()">ë‚ ì”¨ í†µê³„ ì¡°íšŒ</button>
        <button onclick="testWeatherRecommendation()">ë‚ ì”¨ ì¶”ì²œ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="section">
        <h2>ê²°ê³¼</h2>
        <div id="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        async function testCurrentWeather() {
            try {
                const response = await fetch(`${API_BASE}/api/weather/current/`);
                const data = await response.json();
                
                if (data.success) {
                    let html = '<h3>í˜„ì¬ ë‚ ì”¨ (ì„œìš¸ 25ê°œ êµ¬)</h3>';
                    Object.keys(data.data).slice(0, 5).forEach(region => {
                        const weather = data.data[region];
                        html += `<div class="weather-card">
                            <strong>${region}</strong>: ${weather['ê¸°ì˜¨(â„ƒ)']}Â°C, 
                            ìŠµë„ ${weather['ìŠµë„(%)']}%, í’ì† ${weather['í’ì†(m/s)']}m/s
                        </div>`;
                    });
                    html += `<p>ì´ ${Object.keys(data.data).length}ê°œ êµ¬ ë°ì´í„°</p>`;
                    document.getElementById('result').innerHTML = html;
                } else {
                    document.getElementById('result').innerHTML = `<p style="color: red;">ì˜¤ë¥˜: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = `<p style="color: red;">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</p>`;
            }
        }

        async function testMidForecast() {
            try {
                const response = await fetch(`${API_BASE}/api/weather/mid-forecast/`);
                const data = await response.json();
                
                if (data.success) {
                    let html = '<h3>ì¤‘ê¸° ì˜ˆë³´ (ì„œìš¸)</h3>';
                    data.data.slice(0, 10).forEach(item => {
                        html += `<div class="weather-card">
                            <strong>${item.date}</strong> (${item.period}): 
                            ${item.weather_condition || 'ì •ë³´ì—†ìŒ'}, 
                            ê°•ìˆ˜í™•ë¥  ${item.rain_probability || 0}%
                            ${item.min_temperature ? `, ${item.min_temperature}Â°~${item.max_temperature}Â°` : ''}
                        </div>`;
                    });
                    html += `<p>ì´ ${data.data.length}ê±´ ë°ì´í„°</p>`;
                    document.getElementById('result').innerHTML = html;
                } else {
                    document.getElementById('result').innerHTML = `<p style="color: red;">ì˜¤ë¥˜: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = `<p style="color: red;">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</p>`;
            }
        }

        async function testWeatherStats() {
            try {
                const response = await fetch(`${API_BASE}/api/weather/statistics/`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data;
                    let html = '<h3>ë‚ ì”¨ ë°ì´í„° í†µê³„</h3>';
                    html += `<div class="weather-card">
                        <strong>í˜„ì¬ ë‚ ì”¨:</strong> ${stats.current_weather}ê±´<br>
                        <strong>ë‹¨ê¸° ì˜ˆë³´:</strong> ${stats.short_forecast}ê±´<br>
                        <strong>ì¤‘ê¸° ì˜ˆë³´:</strong> ${stats.mid_forecast}ê±´<br>
                        <strong>êµ¬ë²„ì „ ë°ì´í„°:</strong> ${stats.legacy_data}ê±´<br>
                        <strong>ì´í•©:</strong> ${stats.total}ê±´
                    </div>`;
                    document.getElementById('result').innerHTML = html;
                } else {
                    document.getElementById('result').innerHTML = `<p style="color: red;">ì˜¤ë¥˜: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = `<p style="color: red;">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</p>`;
            }
        }

        async function testWeatherRecommendation() {
            try {
                // ì¤‘ê¸° ì˜ˆë³´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`${API_BASE}/api/weather/mid-forecast/`);
                const data = await response.json();
                
                if (data.success) {
                    // í”„ë¡ íŠ¸ì—”ë“œ ë¡œì§ìœ¼ë¡œ ì¶”ì²œ ê³„ì‚°
                    const recommendation = calculateWeatherRecommendation(data.data);
                    
                    let html = '<h3>ë‚ ì”¨ ê¸°ë°˜ ì—¬í–‰ ì¶”ì²œ</h3>';
                    html += `<div class="weather-card">
                        <div class="score-circle">${recommendation.score}</div>
                        <strong>${recommendation.message}</strong>
                    </div>`;
                    
                    html += '<h4>ì¶”ì²œ ë‚ ì§œ TOP 3</h4>';
                    recommendation.bestDays.slice(0, 3).forEach((day, index) => {
                        html += `<div class="weather-card best-day">
                            <strong>#${index + 1} ${day.formattedDate}</strong><br>
                            ì˜¨ë„: ${day.daily?.minTemp || '?'}Â°~${day.daily?.maxTemp || '?'}Â°<br>
                            ê°•ìˆ˜í™•ë¥ : ${Math.round(((day.am?.rainProb || 0) + (day.pm?.rainProb || 0)) / 2)}%<br>
                            ì ìˆ˜: ${day.score}ì 
                        </div>`;
                    });
                    
                    document.getElementById('result').innerHTML = html;
                } else {
                    document.getElementById('result').innerHTML = `<p style="color: red;">ì˜¤ë¥˜: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = `<p style="color: red;">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</p>`;
            }
        }

        // ë‚ ì”¨ ì¶”ì²œ ë¡œì§ (React ì»´í¬ë„ŒíŠ¸ì™€ ë™ì¼)
        function formatMidForecastData(midForecastData) {
            if (!midForecastData || !Array.isArray(midForecastData)) return [];

            const groupedByDate = {};
            
            midForecastData.forEach(item => {
                const date = item.date;
                if (!groupedByDate[date]) {
                    groupedByDate[date] = {
                        date: date,
                        region: item.region,
                        am: null,
                        pm: null,
                        daily: null
                    };
                }
                
                if (item.period === 'Am') {
                    groupedByDate[date].am = {
                        weather: item.weather_condition !== 'nan' ? item.weather_condition : 'ì •ë³´ì—†ìŒ',
                        rainProb: item.rain_probability || 0
                    };
                } else if (item.period === 'Pm') {
                    groupedByDate[date].pm = {
                        weather: item.weather_condition !== 'nan' ? item.weather_condition : 'ì •ë³´ì—†ìŒ',
                        rainProb: item.rain_probability || 0
                    };
                } else if (item.period === 'í•˜ë£¨') {
                    groupedByDate[date].daily = {
                        minTemp: item.min_temperature,
                        maxTemp: item.max_temperature
                    };
                }
            });
            
            return Object.values(groupedByDate)
                .sort((a, b) => a.date.localeCompare(b.date))
                .map(item => ({
                    ...item,
                    formattedDate: formatDate(item.date),
                    hasValidData: item.daily && (item.daily.minTemp || item.daily.maxTemp)
                }));
        }

        function formatDate(dateString) {
            if (!dateString || dateString.length !== 8) return dateString;
            
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);
            
            const date = new Date(year, month - 1, day);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'ì˜¤ëŠ˜';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return 'ë‚´ì¼';
            } else {
                return `${month}/${day}`;
            }
        }

        function calculateWeatherRecommendation(midForecastData) {
            const formattedData = formatMidForecastData(midForecastData);
            
            if (!formattedData || formattedData.length === 0) {
                return {
                    score: 0,
                    message: 'ë‚ ì”¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤',
                    bestDays: [],
                    worstDays: []
                };
            }

            const validDays = formattedData.filter(day => day.hasValidData);
            if (validDays.length === 0) {
                return {
                    score: 0,
                    message: 'ìœ íš¨í•œ ë‚ ì”¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤',
                    bestDays: [],
                    worstDays: []
                };
            }

            // ê° ë‚ ì§œë³„ ì ìˆ˜ ê³„ì‚°
            const scoredDays = validDays.map(day => {
                let score = 50; // ê¸°ë³¸ ì ìˆ˜
                
                // ì˜¨ë„ ì ìˆ˜ (15-25ë„ê°€ ìµœì )
                if (day.daily.maxTemp) {
                    const maxTemp = day.daily.maxTemp;
                    if (maxTemp >= 15 && maxTemp <= 25) {
                        score += 20;
                    } else if (maxTemp >= 10 && maxTemp <= 30) {
                        score += 10;
                    } else {
                        score -= 10;
                    }
                }
                
                // ê°•ìˆ˜ í™•ë¥  ì ìˆ˜
                const avgRainProb = ((day.am?.rainProb || 0) + (day.pm?.rainProb || 0)) / 2;
                if (avgRainProb <= 20) {
                    score += 20;
                } else if (avgRainProb <= 40) {
                    score += 10;
                } else if (avgRainProb <= 60) {
                    score -= 10;
                } else {
                    score -= 20;
                }
                
                return { ...day, score };
            });

            // ì •ë ¬
            const sortedDays = scoredDays.sort((a, b) => b.score - a.score);
            const avgScore = scoredDays.reduce((sum, day) => sum + day.score, 0) / scoredDays.length;

            return {
                score: Math.round(avgScore),
                message: getScoreMessage(avgScore),
                bestDays: sortedDays.slice(0, 3),
                worstDays: sortedDays.slice(-2).reverse(),
                allDays: sortedDays
            };
        }

        function getScoreMessage(score) {
            if (score >= 80) return 'ì™„ë²½í•œ ì—¬í–‰ ë‚ ì”¨ì…ë‹ˆë‹¤! ğŸŒŸ';
            if (score >= 70) return 'ì—¬í–‰í•˜ê¸° ì¢‹ì€ ë‚ ì”¨ì…ë‹ˆë‹¤ â˜€ï¸';
            if (score >= 60) return 'ê´œì°®ì€ ë‚ ì”¨ì…ë‹ˆë‹¤ ğŸŒ¤ï¸';
            if (score >= 50) return 'ë³´í†µ ë‚ ì”¨ì…ë‹ˆë‹¤ â›…';
            if (score >= 40) return 'ì£¼ì˜ê°€ í•„ìš”í•œ ë‚ ì”¨ì…ë‹ˆë‹¤ ğŸŒ§ï¸';
            return 'ì—¬í–‰ì„ ë¯¸ë£¨ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš” â›ˆï¸';
        }
    </script>
</body>
</html>